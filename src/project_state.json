{
  "schemaVersion": "1.0.0",
  "projectStateVersion": 30,
  "summary": "Cityprop is an ICP full-stack dApp evolving toward an Uber-like multi-service marketplace with separate Customer and Driver experiences (role chosen at launch) and strict privacy separation (customers cannot see driver/company wallet details). It supports Internet Identity auth, profiles, driver onboarding/approval (18+, clean background, valid license; applicants email details to cityprop01@gmail.com), driver photo + car info uploads for customer selection, service selection with service-based pricing and deposits (card-required deposits; optional cash for service fee), Stripe-based card processing for deposits, and dashboards for bookings and wallets/earnings. The product also adds multilingual UI (English/Spanish/French with language selector and device-language default), branding/logo/theme controls, and onboarding videos for both customers and drivers. Because GPS/maps aren’t available, location features are address-entry and manual mileage input with rule-based fee calculation (e.g., up to 10 miles: $10 non-refundable deposit + $25 service fee).",
  "existing_features": [
    {
      "id": "IF-1",
      "title": "Internet Identity authentication provider",
      "synonyms": [
        "II login",
        "AuthClient integration"
      ],
      "description": "Provides login/logout via DFINITY Internet Identity using AuthClient, loads persisted delegations on app start, tracks login status flags, and exposes identity to the app via a React context provider.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-2",
      "title": "Backend actor creation and access-control initialization",
      "synonyms": [
        "useActor",
        "admin secret bootstrap"
      ],
      "description": "Creates an authenticated or anonymous backend actor depending on identity. On actor creation, calls _initializeAccessControlWithSecret using a secret token pulled from URL hash/session (caffeineAdminToken) to bootstrap the first admin. React Query invalidation/refetch occurs when identity changes.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-3",
      "title": "Role selection and role-based routing",
      "synonyms": [
        "AppRole flow",
        "Customer/Driver selection"
      ],
      "description": "For authenticated users without a profile, forces a modal role selection (customer or driver) and then runs profile setup. Once a profile exists, routes to the appropriate dashboard (Client/Driver/Admin) and blocks access when not approved.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-4",
      "title": "User profile management (create/read/update)",
      "synonyms": [
        "saveCallerUserProfile",
        "getCallerUserProfile"
      ],
      "description": "Stores and retrieves user profiles containing name, phone, coordinates, and explicit AppRole. Frontend profile setup captures geolocation and required fields and saves via backend APIs.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-5",
      "title": "Driver profile management and photo upload",
      "synonyms": [
        "driver registration",
        "driver listing"
      ],
      "description": "Supports creating/saving driver profiles with car info, coordinates, optional Stripe account id, and photo blob. Drivers can upload a photo (ExternalBlob) and customers can view approved drivers via getAllDrivers; frontend renders photos via blob direct URLs.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-6",
      "title": "Driver approval workflow (request, review, pending screen)",
      "synonyms": [
        "KYC/verification",
        "admin approvals"
      ],
      "description": "Implements a user approval state machine (pending/approved/rejected). Drivers can request approval, admins can list and set approvals, and non-approved users are shown an approval pending screen with instructions (email cityprop01@gmail.com).",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-7",
      "title": "Admin dashboard for approvals and earnings",
      "synonyms": [
        "AdminDashboard",
        "approvals management"
      ],
      "description": "Admin UI to review pending approvals and approve/reject users, plus a company earnings summary and navigation to the full Company Wallet view. Includes Stripe configuration gating via StripeSetupCheck.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-8",
      "title": "Stripe configuration management (admin-only)",
      "synonyms": [
        "StripeSetupCheck",
        "setStripeConfiguration"
      ],
      "description": "Admin can configure Stripe secret key and allowed countries in-canister. Frontend detects configuration status and shows a setup modal when missing.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-9",
      "title": "Stripe checkout session creation (deposit/final/general)",
      "synonyms": [
        "createCheckoutSession",
        "Stripe payments"
      ],
      "description": "Backend can create Stripe Checkout Sessions via HTTPS outcalls; frontend provides hooks to create sessions for general purchases, deposits, and final payments, parsing the returned JSON into {id,url} and redirecting users to Stripe checkout.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-10",
      "title": "Stripe session status lookup",
      "synonyms": [
        "getStripeSessionStatus"
      ],
      "description": "Backend exposes getStripeSessionStatus to query Stripe for a session and extract client_reference_id (user principal) for correlation.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-11",
      "title": "Trip management and listing",
      "synonyms": [
        "createTrip",
        "getClientTrips",
        "getDriverTrips"
      ],
      "description": "Backend defines Trip/TripStatus models and supports creating trips (customer-only), reading a trip with access checks, and listing trips for clients and drivers with admin override.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-12",
      "title": "Trip payment status tracking and updates",
      "synonyms": [
        "PaymentStatus",
        "updateTripPaymentStatus"
      ],
      "description": "Trips include a PaymentStatus enum (pending/paid/transferred). Authorized parties (client/driver/admin) can update a trip’s payment status; frontend invalidates trip and earnings queries after updates.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-13",
      "title": "Wallet and earnings dashboards with polling",
      "synonyms": [
        "DriverWallet",
        "CompanyWallet",
        "earnings polling"
      ],
      "description": "Driver wallet UI computes earnings from completed trips and groups by payment status; company wallet shows commission/deposit totals from backend. Queries for trips/earnings/company earnings poll every 10 seconds for near real-time updates and display syncing indicators.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-14",
      "title": "Instructional video UX and backend video metadata",
      "synonyms": [
        "VideoPlayer",
        "How it works videos"
      ],
      "description": "Reusable VideoPlayer supports autoplay-muted previews, play/pause, mute, fullscreen, and custom controls. Landing and Driver dashboards embed instructional videos. Backend supports admin upload and role-restricted retrieval of video metadata by type.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-15",
      "title": "Responsive UI shell with theming and branding",
      "synonyms": [
        "Header/Footer",
        "Tailwind theme"
      ],
      "description": "App shell includes branded header with role badges, theme toggle (light/dark/system), login/logout controls, and footer. Tailwind configuration provides gold palette and shadows; CSS variables use OKLCH tokens for consistent black-and-gold styling.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-16",
      "title": "Secure URL secret parameter utilities",
      "synonyms": [
        "admin token via hash",
        "urlParams helpers"
      ],
      "description": "Utilities extract secret parameters from URL hash (not sent to servers), persist them in sessionStorage, and clear them from the URL to reduce leakage risk; used for caffeineAdminToken handling.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "IF-17",
      "title": "Internationalization (i18n) framework",
      "synonyms": [
        "I18nProvider",
        "translations"
      ],
      "description": "Frontend includes an i18n provider with translation dictionaries and hooks to render UI strings via localized keys, enabling future multi-language support.",
      "reqIds": [],
      "version": 1
    },
    {
      "id": "feature-publish-the-currently-deployed-draft-version-29-to-the-production-environment-making-it-the-active-version-served-to-end-users",
      "title": "Publish the currently deployed Draft Version 29 to the production environment, making it the active version served to end users.",
      "reqIds": [
        "REQ-1"
      ],
      "version": 1
    }
  ],
  "new_feature_requests": [
    {
      "id": "AR-1",
      "summary": "Split UX into distinct Customer vs Driver paths selected on app launch, with separate dashboards and no cross-visibility of wallet/financial details.",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-2",
      "summary": "Service catalog flow: customer chooses a service (e.g., companion party/hospital/meeting/shopping, shopping-for-them, pickup item) and sees service-specific pricing and required deposit at selection time; support cash vs card rules (deposit by card, service fee optionally cash).",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-3",
      "summary": "Driver onboarding requirements & workflow: collect address/phone/license (active), background check requirement, dress code/clean car policy, car info + car photo + face photo; instruct applicants to email full details to cityprop01@gmail.com for approval.",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-4",
      "summary": "Payments & earnings transparency: implement driver/company pay rules (company deductions/commissions per job, optional $2/job tax withholding with W2 issued; ensure customers see only their own charges while driver/company see their own breakdowns).",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-5",
      "summary": "Internationalization: add language selector (English/Spanish/French) and default to device language (auto-detect) on first load.",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-6",
      "summary": "Onboarding/help videos: add short instructional videos in customer app (how service works; paying drivers cash) and driver app (how they get paid; how Cityprop gets paid; how to accept cash payments).",
      "reqIds": [],
      "status": "pending"
    },
    {
      "id": "AR-7",
      "summary": "Address + mileage pricing without GPS: allow pickup/dropoff address entry and add manual mileage input + automatic fee calculation rules (e.g., up to 10 miles pricing for pickup/shopping).",
      "reqIds": [],
      "status": "pending"
    }
  ],
  "architectural_notes": [
    "Frontend uses React + TanStack React Query; backend interactions are wrapped in custom hooks (useQueries.ts) with cache invalidation and polling (10s) for near real-time updates.",
    "Authentication is via DFINITY Internet Identity (AuthClient) with long-lived delegations (30 days). Identity changes recreate the backend actor and force refetch/invalidation of dependent queries.",
    "Backend is a Motoko actor organized with mixins (authorization, blob storage) and a migration hook (with migration = Migration.run).",
    "Authorization is split into a simple role system (#admin/#user/#guest) plus an application role enum (#customer/#driver). Admin bootstrap is controlled by a shared secret compared against an environment variable (CAFFEINE_ADMIN_TOKEN).",
    "Driver onboarding includes a separate approval subsystem (user-approval/approval.mo) that gates driver features and driver listing.",
    "Stripe integration is implemented via ICP HTTPS outcalls (ic:aaaaa-aa http_request) with a transform function that strips response headers; backend stores Stripe configuration in-canister and exposes “is configured” and “create checkout session” APIs.",
    "Blob storage integration uses a gateway principal allowlist retrieved from a cashier canister; driver photos are stored as ExternalBlob references and rendered via getDirectURL() in the frontend.",
    "UI uses a shadcn-like component set with Tailwind, OKLCH CSS variables for theme tokens, and next-themes for light/dark/system toggling.",
    "Dashboards are role-based: landing page when unauthenticated; mandatory role selection and profile setup when authenticated without a profile; approval-pending screen when not approved; separate customer/driver/admin dashboards thereafter.",
    "Repository/build-template and core canister modules were refreshed to newer component versions (authorization v4.0.0, stripe v3.0.0, http-outcalls v3.0.0, blob-storage v4.0.0, user-approval v3.0.0) along with build-template-react v1.0.0 tooling updates (Dockerfile, scripts, canister yamls, eslint rules, UI library baseline)."
  ],
  "known_issues": [
    "Driver onboarding logic conflict: backend saveCallerUserProfile downgrades any non-approved #driver profile to #customer, but requestApproval requires isDriver(caller) (based on stored profile). This prevents new drivers from successfully requesting approval unless an admin intervenes.",
    "Service booking flows in the UI (ServiceSelectionForm/BookingRequestForm) create Stripe checkout sessions and redirect, but do not create or persist a Trip in the backend (no createTrip call wired in these components), so trips/earnings may remain empty.",
    "Stripe checkout body builder bug: allowedCountries are appended as shipping_address_collection[allowed_countries][0] for every country (index never increments), likely resulting in only one country being recognized by Stripe.",
    "Stripe urlEncode implementation is incomplete (only replaces space, &, =); other reserved characters are not encoded, potentially breaking requests for some inputs/URLs.",
    "DriverEarnings update logic appears incomplete: updateDriverEarnings sets totals (jobs/hours/mileage/earnings) to 0 and replaces paymentBreakdown with a single entry, suggesting a stub rather than an aggregation.",
    "Company earnings calculations sum TripCostCalculation.deposit and companyCommission; comments in UI mention specific per-booking allocations (e.g., $5), but backend lacks explicit tracking of company share vs full deposit amount, risking mismatched reporting.",
    "Environment variable typo risk: blob storage cashier principal env var key is 'CAFFFEINE_STORAGE_CASHIER_PRINCIPAL' (triple 'F') in multiple places; if intended to be 'CAFFEINE...', deployment configuration may fail.",
    "Duplicate/conflicting CSS file content appears in provided listing (frontend/src/index.css and frontend/index.css). If both exist in repo, it may cause theme token conflicts depending on build tooling and imports.",
    "AccessControl.getUserRole traps if a principal is not registered; anonymous actor calls can trigger traps if any query path inadvertently requires #user permissions before initialization.",
    "True Uber-style GPS/maps and automatic mileage calculation are not supported; any mileage/distance logic must be manual or address-based without real-time tracking."
  ],
  "isFixRequest": true,
  "generatedImages": [],
  "gameProjectType": "none",
  "projectName": "Cityprop",
  "clarification_mode": "instant",
  "clarification_rounds": 0
}